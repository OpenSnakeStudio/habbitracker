-- Create user roles enum and table
CREATE TYPE public.app_role AS ENUM ('admin', 'moderator', 'user');

CREATE TABLE public.user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    role app_role NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    UNIQUE (user_id, role)
);

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

-- Security definer function to check roles (prevents recursive RLS)
CREATE OR REPLACE FUNCTION public.has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = _user_id
      AND role = _role
  )
$$;

-- RLS policies for user_roles
CREATE POLICY "Users can view their own roles"
ON public.user_roles
FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Admins can manage all roles"
ON public.user_roles
FOR ALL
USING (public.has_role(auth.uid(), 'admin'));

-- Legal documents table
CREATE TABLE public.legal_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type TEXT NOT NULL UNIQUE CHECK (type IN ('terms', 'privacy', 'data_processing')),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    version INTEGER NOT NULL DEFAULT 1,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    updated_by UUID REFERENCES auth.users(id)
);

ALTER TABLE public.legal_documents ENABLE ROW LEVEL SECURITY;

-- Everyone can read legal documents
CREATE POLICY "Everyone can read legal documents"
ON public.legal_documents
FOR SELECT
USING (true);

-- Only admins can update legal documents
CREATE POLICY "Admins can update legal documents"
ON public.legal_documents
FOR UPDATE
USING (public.has_role(auth.uid(), 'admin'));

CREATE POLICY "Admins can insert legal documents"
ON public.legal_documents
FOR INSERT
WITH CHECK (public.has_role(auth.uid(), 'admin'));

-- User permissions table
CREATE TABLE public.user_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    analytics_enabled BOOLEAN NOT NULL DEFAULT true,
    notifications_enabled BOOLEAN NOT NULL DEFAULT true,
    personalized_ads BOOLEAN NOT NULL DEFAULT false,
    data_sharing BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

ALTER TABLE public.user_permissions ENABLE ROW LEVEL SECURITY;

-- Users can only manage their own permissions
CREATE POLICY "Users can view their own permissions"
ON public.user_permissions
FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own permissions"
ON public.user_permissions
FOR INSERT
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own permissions"
ON public.user_permissions
FOR UPDATE
USING (auth.uid() = user_id);

-- Insert default legal documents
INSERT INTO public.legal_documents (type, title, content) VALUES
('terms', 'Условия использования', '# Условия использования

**УСЛОВИЯ ОБСЛУЖИВАНИЯ TOP-FOCUS**
Дата вступления в силу: 01 января 2026 г.

**1. ВВЕДЕНИЕ**
Это условия обслуживания приложения TOP-FOCUS. Используя приложение, вы соглашаетесь со всеми положениями этого документа.
**2. КОМПАНИЯ И КОНТАКТЫ**
Реквизиты:
Организация: ООО «АЦМ»
ИНН: 9713007100
ОГРН: 1237700876511
Контакты:
Email поддержки: support@top-focus.ru
Email ошибок: bugs@top-focus.ru
Email жалоб: complaints@top-focus.ru
**3. КТО МОЖЕТ ИСПОЛЬЗОВАТЬ**
Возрастные требования:
Минимум 14 лет
От 14-18 лет требуется согласие родителя
Ваши обязанности:
- Предоставлять только правдивую информацию
- Использовать приложение законно
- Не передавать пароль никому
- Не передавать аккаунт другим людям
- Соблюдать все правила
- Регулярно обновлять приложение
- Сохранять резервные копии данных
**4. ЗАПРЕЩЁННЫЕ ДЕЙСТВИЯ**
Запрещено:
- Попытки взлома приложения или сервера
- Внедрение вирусов или вредоноса
- DDoS атаки на серверы
- Использование украденных платёжных карт
- Требование возврата после использования
- Использование чужого аккаунта
- Продажа или передача подписки
- Оскорбления и угрозы другим
- Распространение личной информации других
- Пропаганда ненависти и дискриминации
- Преследование и домогательства
Последствия:
- Первое нарушение: блокировка на 30 дней
- Повторные нарушения: постоянная блокировка
- Преступная деятельность: немедленная блокировка и заявление в полицию
**5. ОТВЕТСТВЕННОСТЬ КОМПАНИИ**
Что компания **НЕ** гарантирует:
- Бесперебойную работу (возможны временные сбои)
- Отсутствие ошибок (как во всех приложениях)
- Совместимость со всеми устройствами
- Восстановление удалённых данных
- Результаты использования приложения
Ограничение ответственности:
- Максимум: одна платёжная сумма за последние 30 дней
- Исключены: косвенные убытки, потеря доходов, моральный вред
- Не отвечаем за: потерю интернета, ошибки пользователя, старые устройства
**6. ОТВЕТСТВЕННОСТЬ ПОЛЬЗОВАТЕЛЯ**
Вы отвечаете за:
- Безопасность пароля (не передавайте его)
- Все действия с вашего аккаунта
- Ввод правильной информации
- Сохранение собственных копий важных данных
- Обновление контактной информации
- Соблюдение всех правил и законов
- Оплату услуг в полном объёме
Компания НЕ отвечает за:
- Потерю пароля
- Взлом аккаунта (если пароль слабый)
- Действия других с вашего аккаунта
- Потерю данных при вашей ошибке
- Использование на старом устройстве
**7. БЛОКИРОВКА АККАУНТА**
Временная блокировка (30 дней):
- Первое нарушение правил
- Попытки взлома
- Использование фальшивых данных
- Спам или оскорбления
- Более 10 неправильных попыток входа
- Платёжные проблемы
Постоянная блокировка (навсегда):
- Повторные нарушения после временной блокировки
- Преступная деятельность
- Угрозы или насилие
- Дискриминация и пропаганда ненависти
- Попытка передать LIFETIME подписку
- Попытка продать аккаунт
Апелляция: 
Email: support@top-focus.ru
- Тема: [АПЕЛЛЯЦИЯ] Описание
- Сроки рассмотрения: 7-14 дней
- Результат: восстановление доступа или объяснение отказа
**8. УДАЛЕНИЕ АККАУНТА**
Как удалить:
Настройки → Аккаунт → [Удалить аккаунт]
Подтвердить намерение (необратимо)
Процесс удаления:
- День 1-30: аккаунт неактивен, данные в облаке
- День 30: можно отменить удаление (ссылка в письме)
- День 31: полное удаление данных
- После дня 31: восстановление невозможно
**Важно:**
- Экспортируйте данные ДО удаления
- Удалённые данные не восстанавливаются
- Резервные копии не сохраняются
**9. ИЗМЕНЕНИЯ И ОБНОВЛЕНИЯ**
Компания может менять:
- Добавлять новые функции
- Улучшать функции
- Менять интерфейс
- Менять обработчиков данных
- Обновлять условия
Сроки уведомления:
- Негативные изменения (удаление функции, повышение цены): 14 дней
- Нейтральные изменения (интерфейс): 7 дней
- Положительные (новая функция): 3 дня или сразу
- Безопасность (уязвимость): немедленно
Если вы не согласны:
- Можете отменить подписку в период уведомления
- Или обратиться в суд
**10. ОБНОВЛЕНИЯ ПРИЛОЖЕНИЯ**
Требования:
- iOS: минимум 13.0
- Android: минимум 9.0
- Web: Chrome 90+, Safari 14+, Firefox 88+
- Память: 100-150 MB свободного места
- Интернет: 2G+ (рекомендуется 4G/LTE)
Поддержка версий:
Текущая версия: полная поддержка
1-2 месяца: полная поддержка
3+ месяца: частичная поддержка
6+ месяцев: поддержка прекращена
Рекомендация: Обновляйте приложение регулярно
**11. ПРЕТЕНЗИИ И СПОРЫ**
Претензионный порядок:
Шаг 1: Попробуйте решить с поддержкой
Email: support@top-focus.ru
Время ответа: 7-30 рабочих дней
Шаг 2: Официальная претензия
Email: complaints@top-focus.ru
Тема: [ПРЕТЕНЗИЯ] Описание
Включить: ФИ, описание, требование, срок (не менее 7 дней)
Шаг 3: Ответ Компании
Время рассмотрения: 7-30 дней
Согласие или обоснованный отказ
Шаг 4: Суд (если претензия не решена)
Исковое заявление в мировой суд г. Москвы
**12. СУДЕБНОЕ РАЗБИРАТЕЛЬСТВО**
Применимое право:
Законодательство Российской Федерации
ФЗ № 2300-1 (защита прав потребителей)
ГК РФ (Гражданский кодекс)
ФЗ № 152-ФЗ (защита персональных данных)
ФЗ № 149-ФЗ (об информации)
Юрисдикция:
Мировой суд г. Москвы (первая инстанция)
Московский областной суд (апелляция)
Верховный суд РФ (кассация)
Место:
По месту нахождения Компании: г. Москва
Сроки исковой давности:
- По защите прав потребителя: 3 года
- По взысканию убытков: 3 года
**13. ОШИБКИ И ТЕХПОДДЕРЖКА**
Как сообщить об ошибке:
Email: bugs@top-focus.ru
Что включить в отчёт:
- Описание: что произошло и когда
- Устройство: модель и версия ОС
- Версия: см. в Настройках → О приложении
- Скриншот или видео (если возможно)
- Email для связи
Сроки рассмотрения:
- Критичные (приложение падает): 24-72 часа
- Серьёзные (функция не работает): 3-7 дней
- Обычные (функция работает неправильно): 1-2 недели
- Мелкие (опечатки, UI): 1-4 недели
Награда за ошибки:
1-6 месяцев бесплатной PRO подписки
**14. ОБЛАЧНАЯ СИНХРОНИЗАЦИЯ**
Как работает:
- Данные синхронизируются между вашими устройствами
- Хранятся в защищённом облаке
- Шифруются при передаче и хранении
Вы отвечаете за:
- Сохранность пароля (если синхронизация скомпрометирована)
- Данные считаются синхронизированными с момента загрузки
Компания **НЕ отвечает** за:
- Потерю интернета во время синхронизации
- Конфликты данных при одновременном редактировании
- Редкие перебои облачного хранилища
**15. РЕЗЕРВНЫЕ КОПИИ И ЭКСПОРТ**
Автоматические резервные копии:
- Ежедневно в облаке (PRO тариф)
- Хранение: 7 дней (PRO), 30 дней (LIFETIME)
- Восстановление: до 24 часов
Ручной экспорт:
- CSV формат (таблицы Excel)
- JSON формат (для программистов)
- PDF отчёты (красивые документы)
- Скачивание: Настройки → Данные → [Экспортировать]
Восстановление:
- Скачать версию на определённую дату
- Восстановить последнюю версию
- Время: 5-15 минут

**Компания НЕ отвечает за действия третьих сервисов**

**16. ФИНАЛЬНЫЕ ПОЛОЖЕНИЯ**
Действие:
- Вступление в силу: 01 января 2026 года
- Действует на неопределённый срок
- Распространяется на все платформы (iOS, Android, Web)
- Действует во всех странах, где доступно приложение
Полнота соглашения:
- Этот документ в сочетании с другими документами составляет полное соглашение
- Заменяет все предыдущие версии
Язык:
- Официальный язык: русский
- При расхождениях с переводами: приоритет русской версии
Невозможность исполнения:
- Форс-мажор (война, катастрофы, пандемии): Компания не отвечает
- Решение регуляторов: компания ищет альтернативы
**КОНТАКТЫ**
Вопросы по условиям обслуживания?
Email: support@top-focus.ru
Документ выверен правовым отделом ООО «АЦМ»

Дата вступления в силу: 01 января 2026 года

Версия: 1.0

Согласие с этими условиями означает, что вы прочитали, поняли и согласны со всеми положениями.

© ООО «АЦМ» 2025-2026. Все права защищены.'),
('privacy', 'Политика конфиденциальности', '# Политика конфиденциальности

1. **Сбор данных**
   - Мы собираем данные, которые вы вводите в приложение.
   - Данные хранятся защищённо.

2. **Использование данных**
   - Данные используются для работы приложения.
   - Мы не продаём ваши данные третьим лицам.

3. **Защита данных**
   - Данные передаются по защищённому соединению.'),
('data_processing', 'Политика обработки персональных данных', '# Политика обработки персональных данных

1. **Оператор**
   - Оператором персональных данных является разработчик приложения.

2. **Цели обработки**
   - Персональные данные обрабатываются для предоставления услуг.

3. **Права субъекта**
   - Вы имеете право на доступ, изменение и удаление своих данных.');